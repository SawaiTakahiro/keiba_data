# keiba_data
## 目的
- 競馬のデータを取得して予想に役立てたい
- JRA-VANのデータをいい感じに加工して、扱えるようにする

## やること
- EveryDB2で取得したデータを、rubyで扱いやすい形にする
    - そのあと、データをどうするかはまたその時に考える
    - …と思ったけど、データベースでやるべきところは、普通にデータベースの方がよさげ
    - rubyは操作のラッピングに止めておく

## 上がり指数の更新手順
1. keiba_data.dbを持ってくる
    - 手動。ファイルがでかいので注意
2. init_table.rbを実行
    - すでにlocaldata.dbが存在してたらやらなくてもいいかも
3. add_last3f.rbを実行
4. get_last3f_hensachi.rbを実行
5. save_index_last3f.rbを実行
    - sqliteの方で直接csv保存しちゃってもいいかも
    - ファイル分けた方が軽いことは軽いけど…　いうてそんな死ぬほど重くなかったし…

### 上がり指数に関係するスクリプトなど
- add_last3f.rb
    - last3fってなっているけど、その他もいろいろ足している
    - keiba_data.dbからデータを持ってくる処理をしている
- config.rb
    - データベースのパスとかまとめてる
- get_last3f_hensachi.rb
    - 外部指数用に偏差値を求めて、localdataに追加する
    - とりあえず、重い処理なので注意
    - add_last3fなんかでデータを持ってきておかないと処理できない（追加されない）
    - すでに保存済みのレースIDも飛ばすようにしているので、出力し直す場合はテーブルからデータを消すこと
- get_list_jouken.rb
    - そのレースがどんな条件（クラス、距離、馬場など）だったかを求めている
    - でも、これは不要なスクリプトかな。使ってない
    - 今使っている条件リストはSQLで求めていて、なおかつadd_last3f.rbで実行している
- get_seiseki.rb
    - 成績をlocaldataに追加するスクリプト
    - keiba_dataからデータを取ってきて、それをlocaldataにinsertしている
    - ひょっとして、add_last3fでやってる他の処理と同じかも
        - 存在自体を整理できるかもしれないスクリプト
- get_zenso_raceid.rb
    - 前走のレースIDを求めるスクリプト
    - 今回レースID, 前回レースIDというテーブルを作っている
    - シフトさせて求めるという、ワイルドな処理になっている
        - たぶん正しく動いているかなあ…
        - 何頭か見てみた感じ、間違ったデータは入っていなそう
    - 上がり指数の検証用に作ったので、普段は使わないはず
- init_table.rb
    - localdata.dbの初期化をする
    - テーブルがないとinsertとかできないので。ここではテーブルを作るだけ。
    - ひょっとしたら、add_last3f（と呼んでいるスクリプト）と合わせちゃってもいいのかも
- kensho_last3f_hensachi.rb
    - 検証用。上がり指数を作ることには関係ない
- library.rb
    - 共通の処理をいれたやつ
    - 相関係数を求めたりするArrayクラスの拡張もこれに入れたりしている
- save_index_last3f.rb
    - 上がり指数をファイルとして保存するスクリプト
    - 実は不要かも？
        - １ファイルにまとめたままでも、そこまで死ぬほど遅くはなかったし…

## 払い戻し
- 払い戻しを求めるよ！


## メモ
- rubyでやるにはちょっと重すぎ
    - 件数が増えてくると顕著
    - rubyじゃなくてもできるところは、rubyでやろうとしない
    - 件数が20万件を超えるものはダメかも

## ボツ
### ざっくりとした構造
- Template_keiba_table
    - 馬単位のデータ
    - Template_keiba_table_umaban
        - Table_x_uma_race
    - レース単位のデータ
    - Table_x_race
    - Table_x_harai